<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./timeline.css" />
  <title>HealthBud â€¢ Timeline</title>
</head>
<body>

  <header class="topbar">
    <a class="back" href="./homepage.html">â† Home</a>
    <div class="brand" aria-label="HealthBud">
      <div class="brand_mark" aria-hidden="true"></div>
      <h1 class="brand_name">HealthBud</h1>
    </div>
    <button class="ghost_btn" id="refreshBtn" type="button">â†» Refresh</button>
  </header>

  <main class="tl_shell" aria-label="Symptom Timeline">
    <div class="tl_layout">

      <!-- Hero -->
      <section class="tl_hero" aria-label="Timeline intro">
        <div class="hero_icon">ğŸ“Š</div>
        <div class="hero_text">
          <h2 id="heroTitle">Your Symptom Timeline</h2>
          <p id="heroSub">Track symptoms over time and spot patterns that matter.</p>
        </div>
      </section>

      <!-- Quick Log -->
      <section class="quick_log" aria-label="Log a symptom">
        <form class="quick_log_form" id="logForm" autocomplete="off">
          <div class="field">
            <label for="symptomInput">What's bothering you?</label>
            <input id="symptomInput" type="text" placeholder="e.g. Headache, Nausea, Back painâ€¦" required />
          </div>

          <div class="field">
            <label for="severityInput">Severity</label>
            <div class="severity_wrap">
              <input class="severity_track" id="severityInput" type="range" min="0" max="10" step="0.5" value="5" />
              <div class="severity_badge mid" id="sevBadge">5 / 10 â€” Moderate</div>
            </div>
          </div>

          <div class="field">
            <label for="notesInput">Notes (optional)</label>
            <input id="notesInput" type="text" placeholder="Started after lunchâ€¦" />
          </div>

          <button class="log_btn" type="submit" id="logBtn">+ Log</button>
          <p class="log_error" id="logError" aria-live="polite"></p>
        </form>

        <!-- Quick symptom tags -->
        <div class="quick_tags">
          <span class="quick_tags_label">Quick add:</span>
          <button class="tag" type="button" data-symptom="Headache">ğŸ¤• Headache</button>
          <button class="tag" type="button" data-symptom="Nausea">ğŸ¤¢ Nausea</button>
          <button class="tag" type="button" data-symptom="Fever">ğŸ¤’ Fever</button>
          <button class="tag" type="button" data-symptom="Fatigue">ğŸ˜´ Fatigue</button>
          <button class="tag" type="button" data-symptom="Back pain">ğŸ©¹ Back pain</button>
          <button class="tag" type="button" data-symptom="Sore throat">ğŸ˜®â€ğŸ’¨ Sore throat</button>
          <button class="tag" type="button" data-symptom="Anxiety">ğŸ˜Ÿ Anxiety</button>
          <button class="tag" type="button" data-symptom="Cough">ğŸ¤§ Cough</button>
        </div>
      </section>

      <!-- Stats -->
      <section class="stats_grid" id="statsGrid" aria-label="Statistics"></section>

      <!-- Breakdown -->
      <section class="breakdown_card" aria-label="Symptom breakdown">
        <div class="section_head">
          <h3>ğŸ“‹ Symptom Breakdown</h3>
        </div>
        <div class="breakdown_list" id="breakdownList"></div>
      </section>

      <!-- History -->
      <section class="history_card" aria-label="History">
        <div class="history_header">
          <h3>ğŸ• History</h3>
          <div class="filter_wrap">
            <input class="filter_input" id="filterInput" type="text" placeholder="Search symptomsâ€¦" aria-label="Filter" />
          </div>
        </div>
        <div id="historyContainer"></div>
      </section>

    </div>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 0) Auth guard
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const token = localStorage.getItem("hb_token");
    if (!token) window.location.href = "./getstarted.html";

    let userName = "";
    try {
      const u = JSON.parse(localStorage.getItem("hb_user") || "{}");
      if (u.name) userName = u.name.split(" ")[0];
    } catch {}

    if (userName) {
      document.getElementById("heroTitle").textContent = `${userName}'s Symptom Timeline`;
    }

    const API_BASE = "http://127.0.0.1:8000";
    let backendAvailable = false;

    async function checkBackend() {
      try {
        const r = await fetch(`${API_BASE}/health`, { signal: AbortSignal.timeout(2000) });
        if (r.ok) backendAvailable = true;
      } catch {}
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1) Local storage
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const LOG_KEY = "hb_symptom_logs";

    function getLogs() {
      try { return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); }
      catch { return []; }
    }

    function saveLogs(logs) {
      localStorage.setItem(LOG_KEY, JSON.stringify(logs));
    }

    function addLog(symptom, severity, notes) {
      const logs = getLogs();
      const entry = {
        id: Date.now(),
        symptom: symptom.trim(),
        severity,
        notes: notes.trim(),
        logged_at: new Date().toISOString(),
      };
      logs.unshift(entry);
      saveLogs(logs);
      return entry;
    }

    function removeLog(id) {
      saveLogs(getLogs().filter(l => l.id !== id));
    }

    function calcStats() {
      const logs = getLogs();
      if (!logs.length) return [];

      const m = {};
      for (const l of logs) {
        const k = l.symptom.toLowerCase();
        if (!m[k]) m[k] = { symptom: l.symptom, count: 0, total: 0, latest: l.logged_at };
        m[k].count++;
        m[k].total += l.severity;
        if (l.logged_at > m[k].latest) m[k].latest = l.logged_at;
      }

      return Object.values(m)
        .map(s => ({ ...s, avg_severity: Math.round((s.total / s.count) * 10) / 10 }))
        .sort((a, b) => b.count - a.count);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2) DOM refs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const logForm       = document.getElementById("logForm");
    const symptomInput  = document.getElementById("symptomInput");
    const severityInput = document.getElementById("severityInput");
    const sevBadge      = document.getElementById("sevBadge");
    const notesInput    = document.getElementById("notesInput");
    const logBtn        = document.getElementById("logBtn");
    const logError      = document.getElementById("logError");
    const statsGrid     = document.getElementById("statsGrid");
    const breakdownList = document.getElementById("breakdownList");
    const historyEl     = document.getElementById("historyContainer");
    const filterInput   = document.getElementById("filterInput");
    const toastEl       = document.getElementById("toast");

    let allLogs = [];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3) Helpers
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function sc(v) { return v <= 3 ? "low" : v <= 6 ? "mid" : "high"; }
    function sw(v) { return v <= 3 ? "Mild" : v <= 6 ? "Moderate" : "Severe"; }
    function esc(s){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

    function fmtDate(iso) {
      const d = new Date(iso);
      const now = new Date();
      const diff = now - d;
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(diff / 3600000);

      if (mins < 1) return "Just now";
      if (mins < 60) return `${mins}m ago`;
      if (hrs < 24) return `${hrs}h ago`;

      return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" })
        + " Â· " + d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
    }

    function symptomEmoji(name) {
      const n = name.toLowerCase();
      if (/headache|migraine|head/.test(n)) return "ğŸ¤•";
      if (/nausea|vomit|stomach/.test(n)) return "ğŸ¤¢";
      if (/fever|temperature|chills/.test(n)) return "ğŸ¤’";
      if (/fatigue|tired|exhaust/.test(n)) return "ğŸ˜´";
      if (/cough|cold|flu|sneez/.test(n)) return "ğŸ¤§";
      if (/anxiety|stress|panic|nervous/.test(n)) return "ğŸ˜Ÿ";
      if (/pain|ache|sore|hurt/.test(n)) return "ğŸ©¹";
      if (/throat/.test(n)) return "ğŸ˜®â€ğŸ’¨";
      if (/skin|rash|itch/.test(n)) return "ğŸ”´";
      if (/breath/.test(n)) return "ğŸ’¨";
      if (/dizzin|dizzy|faint/.test(n)) return "ğŸ’«";
      return "ğŸ“Œ";
    }

    function toast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2500);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4) Severity slider
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateSev() {
      const v = parseFloat(severityInput.value);
      sevBadge.textContent = `${v} / 10 â€” ${sw(v)}`;
      sevBadge.className = `severity_badge ${sc(v)}`;
    }
    severityInput.addEventListener("input", updateSev);
    updateSev();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5) Quick tags
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.querySelectorAll(".tag").forEach(tag => {
      tag.addEventListener("click", () => {
        symptomInput.value = tag.dataset.symptom;
        symptomInput.focus();
      });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 6) Render stats
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderStats(stats) {
      const logs = getLogs();
      const total = logs.length;
      const unique = stats.length;
      const avg = total ? (logs.reduce((s, l) => s + l.severity, 0) / total).toFixed(1) : "â€“";
      const top = stats[0];

      statsGrid.innerHTML = `
        <div class="stat_card">
          <div class="stat_icon">ğŸ“</div>
          <div class="stat_value teal">${total}</div>
          <div class="stat_label">Total Logs</div>
        </div>
        <div class="stat_card">
          <div class="stat_icon">ğŸ”</div>
          <div class="stat_value blue">${unique}</div>
          <div class="stat_label">Unique Symptoms</div>
        </div>
        <div class="stat_card">
          <div class="stat_icon">ğŸ“ˆ</div>
          <div class="stat_value purple">${avg}</div>
          <div class="stat_label">Avg Severity</div>
        </div>
        <div class="stat_card">
          <div class="stat_icon">${top ? symptomEmoji(top.symptom) : "â€”"}</div>
          <div class="stat_value warm" style="font-size:${top && top.symptom.length > 10 ? 18 : 22}px">${top ? esc(top.symptom) : "â€“"}</div>
          <div class="stat_label">${top ? `${top.count} log${top.count !== 1 ? "s" : ""} Â· Most frequent` : "Most Frequent"}</div>
        </div>
      `;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 7) Render breakdown
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderBreakdown(stats) {
      if (!stats.length) {
        breakdownList.innerHTML = `
          <div class="empty_state">
            <div class="empty_icon">ğŸ“‹</div>
            <h3>No symptoms tracked yet</h3>
            <p>Log your first symptom above to see a breakdown of patterns.</p>
          </div>`;
        return;
      }

      const maxCount = stats[0].count;

      breakdownList.innerHTML = stats.map((s, i) => {
        const barWidth = Math.max(8, (s.avg_severity / 10) * 100);
        return `
          <div class="bd_item" style="animation-delay:${i * 0.06}s">
            <div class="bd_emoji">${symptomEmoji(s.symptom)}</div>
            <div class="bd_info">
              <div class="bd_name">${esc(s.symptom)}</div>
              <div class="bd_bar_wrap">
                <div class="bd_bar ${sc(s.avg_severity)}" style="width:${barWidth}%"></div>
              </div>
            </div>
            <div class="bd_meta">
              <span class="bd_count">${s.count}Ã—</span>
              <span class="bd_sev ${sc(s.avg_severity)}">Avg ${s.avg_severity}</span>
            </div>
          </div>`;
      }).join("");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 8) Render history
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderHistory(logs) {
      if (!logs.length) {
        historyEl.innerHTML = `
          <div class="empty_state">
            <div class="empty_icon">ğŸ•</div>
            <h3>Your timeline is empty</h3>
            <p>Tap a quick tag or type a symptom above to start tracking.</p>
          </div>`;
        return;
      }

      historyEl.innerHTML = `<div class="timeline">${logs.map((l, i) => `
        <div class="tl_entry sev_${sc(l.severity)}" data-id="${l.id}" style="animation-delay:${i * 0.04}s">
          <div class="entry_top">
            <span class="entry_symptom">${symptomEmoji(l.symptom)} ${esc(l.symptom)}</span>
            <span class="entry_sev_pill ${sc(l.severity)}">${l.severity}/10 Â· ${sw(l.severity)}</span>
          </div>
          ${l.notes ? `<p class="entry_notes">${esc(l.notes)}</p>` : ""}
          <div class="entry_bottom">
            <span class="entry_time">ğŸ• ${fmtDate(l.logged_at)}</span>
            <button class="del_btn" type="button" data-id="${l.id}">Remove</button>
          </div>
        </div>
      `).join("")}</div>`;

      historyEl.querySelectorAll(".del_btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = parseInt(btn.dataset.id);
          if (!confirm("Remove this log?")) return;

          if (backendAvailable) {
            try {
              await fetch(`${API_BASE}/timeline/log/${id}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              });
            } catch {}
          }

          removeLog(id);
          loadAll();
          toast("Log removed");
        });
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 9) Filter
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    filterInput.addEventListener("input", () => {
      const q = filterInput.value.trim().toLowerCase();
      renderHistory(q ? allLogs.filter(l => l.symptom.toLowerCase().includes(q)) : allLogs);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 10) Load all
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadAll() {
      let stats, logs;

      if (backendAvailable) {
        try {
          const h = { Authorization: `Bearer ${token}` };
          const [sR, lR] = await Promise.all([
            fetch(`${API_BASE}/timeline/stats`, { headers: h }),
            fetch(`${API_BASE}/timeline/history?limit=200`, { headers: h }),
          ]);
          if (sR.ok && lR.ok) {
            stats = await sR.json();
            logs = await lR.json();
            saveLogs(logs);
          } else throw new Error();
        } catch {
          backendAvailable = false;
          stats = calcStats();
          logs = getLogs();
        }
      } else {
        stats = calcStats();
        logs = getLogs();
      }

      allLogs = logs;
      renderStats(stats);
      renderBreakdown(stats);
      renderHistory(logs);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 11) Submit
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ï¿½ï¿½â•â•â•â•â•â•â•â•â•
    logForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      logError.textContent = "";

      const symptom = symptomInput.value.trim();
      const severity = parseFloat(severityInput.value);
      const notes = notesInput.value.trim();

      if (!symptom) { logError.textContent = "Enter a symptom to log."; return; }

      logBtn.disabled = true;
      logBtn.textContent = "Loggingâ€¦";

      addLog(symptom, severity, notes);

      if (backendAvailable) {
        try {
          await fetch(`${API_BASE}/timeline/log`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ symptom, severity, notes }),
          });
        } catch { backendAvailable = false; }
      }

      symptomInput.value = "";
      severityInput.value = 5;
      notesInput.value = "";
      updateSev();

      logBtn.disabled = false;
      logBtn.textContent = "+ Log";

      loadAll();
      toast(`âœ“ Logged "${symptom}" â€” ${severity}/10`);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 12) Refresh
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById("refreshBtn").addEventListener("click", () => {
      loadAll();
      toast("â†» Refreshed");
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Init
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    checkBackend().then(loadAll);
  </script>
</body>
</html>