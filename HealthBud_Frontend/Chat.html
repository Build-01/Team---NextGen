<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./Chat.css" />
  <title>HealthBud ‚Ä¢ Chat</title>
</head>
<body>

  <!-- ===== Topbar ===== -->
  <header class="topbar">
    <a class="back" href="./homepage.html">‚Üê Home</a>
    <div class="brand" aria-label="HealthBud">
      <div class="brand_mark" aria-hidden="true"></div>
      <h1 class="brand_name">HealthBud</h1>
    </div>
    <div class="topbar_actions">
      <button class="ghost_btn" id="clearBtn" type="button">Clear Chat</button>
    </div>
  </header>

  <!-- ===== Chat ===== -->
  <main class="chat_shell" aria-label="Chat">
    <section class="chat_card">

      <!-- Header with AI avatar -->
      <div class="chat_header">
        <div class="ai_avatar" aria-hidden="true">ü©∫</div>
        <div class="header_text">
          <h2 id="headerTitle">HealthBud Assistant</h2>
          <p class="header_sub" id="headerSub">Your personal health companion</p>
        </div>
        <div class="status_pill offline" id="statusPill">
          <span class="status_dot"></span>
          <span id="statusText">Ready</span>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>

      <!-- Composer -->
      <form class="composer" id="composer" autocomplete="off">
        <div class="composer_input_wrap">
          <input
            id="messageInput"
            type="text"
            placeholder="Describe how you're feeling‚Ä¶"
            aria-label="Message"
            required
          />
        </div>
        <button class="send_btn" type="submit" id="sendBtn" aria-label="Send message">
          <span class="send_icon">‚ûú</span>
        </button>
      </form>

      <!-- Disclaimer -->
      <p class="disclaimer">
        HealthBud provides informational guidance only ‚Äî not medical diagnoses. Always consult a healthcare professional.
      </p>

    </section>
  </main>

  <script>
    const token = localStorage.getItem("hb_token");
    if (!token) window.location.href = "./getstarted.html";

    let userName = "there";
    let userInitial = "U";
    try {
      const u = JSON.parse(localStorage.getItem("hb_user") || "{}");
      if (u.name) {
        userName = u.name.split(" ")[0];
        userInitial = u.name.charAt(0).toUpperCase();
      }
    } catch {}

    document.getElementById("headerSub").textContent =
      `Hi ${userName} ‚Äî tell me what‚Äôs on your mind. I can chat generally and help with health check-ins too.`;

    const API_BASE = `${window.location.origin}/api/v1`;
    const STORAGE_KEY = "hb_chat_messages_v1";
    const SESSION_KEY = "hb_chat_session_id_v1";
    const TIMELINE_KEY = "hb_symptom_logs";
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("messageInput");
    const composerEl = document.getElementById("composer");
    const sendBtn = document.getElementById("sendBtn");

    let chat = [];
    let backendAvailable = false;
    let sessionId = localStorage.getItem(SESSION_KEY) || "";

    function setStatus(type, text) {
      const pill = document.getElementById("statusPill");
      const label = document.getElementById("statusText");
      pill.className = `status_pill ${type}`;
      label.textContent = text;
    }

    async function checkBackend() {
      try {
        const res = await fetch(`${window.location.origin}/health`, { signal: AbortSignal.timeout(2000) });
        backendAvailable = res.ok;
      } catch {
        backendAvailable = false;
      }
      setStatus(backendAvailable ? "online" : "offline", backendAvailable ? "AI Connected" : "Offline");
    }

    function esc(s) {
      return s
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatText(text) {
      let html = esc(text || "");
      html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      return html;
    }

    function formatAssistantRichText(text) {
      const raw = String(text || "").trim();
      if (!raw) return "";

      const lines = raw.split("\n");
      const htmlParts = [];
      let bullets = [];

      function flushBullets() {
        if (!bullets.length) return;
        htmlParts.push(`<ul class="assistant_list">${bullets.map(item => `<li>${esc(item)}</li>`).join("")}</ul>`);
        bullets = [];
      }

      for (const lineRaw of lines) {
        const line = lineRaw.trim();
        if (!line) continue;

        if (line === "---") {
          flushBullets();
          continue;
        }

        if (line.startsWith("‚Ä¢ ")) {
          bullets.push(line.slice(2).trim());
          continue;
        }

        flushBullets();

        if (/^Urgency\s*:/i.test(line)) {
          const value = line.split(":").slice(1).join(":").trim();
          const urgencyClass = /emergency/i.test(value)
            ? "emergency"
            : /high/i.test(value)
              ? "high"
              : /medium/i.test(value)
                ? "medium"
                : "low";
          htmlParts.push(`<div class="assistant_meta"><span class="urgency_chip ${urgencyClass}">Urgency: ${esc(value || "unknown")}</span></div>`);
          continue;
        }

        if (/^When to seek care\s*:/i.test(line) || /^Reason\s*:/i.test(line) || /^Summary\s*:/i.test(line)) {
          const [label, ...rest] = line.split(":");
          htmlParts.push(`<p class="assistant_row"><strong>${esc(label)}:</strong> ${esc(rest.join(":").trim())}</p>`);
          continue;
        }

        if (line.endsWith(":")) {
          htmlParts.push(`<h4 class="assistant_heading">${esc(line.slice(0, -1))}</h4>`);
          continue;
        }

        htmlParts.push(`<p class="assistant_p">${esc(line)}</p>`);
      }

      flushBullets();
      return `<div class="assistant_rich">${htmlParts.join("")}</div>`;
    }

    function timeStr(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function loadChat() {
      try { chat = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { chat = []; }
    }

    function saveChat() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chat));
    }

    function saveSessionId(id) {
      sessionId = id || "";
      if (sessionId) {
        localStorage.setItem(SESSION_KEY, sessionId);
      } else {
        localStorage.removeItem(SESSION_KEY);
      }
    }

    function renderWelcome() {
      messagesEl.innerHTML = `
        <div class="welcome">
          <div class="welcome_icon">ü©∫</div>
          <h3>How can I help you today?</h3>
          <p>I can chat naturally and also help with symptom check-ins when needed.</p>
          <div class="quick_chips" id="quickChips">
            <button class="chip" type="button">ü§í I have a fever</button>
            <button class="chip" type="button">ü§ï Headache for days</button>
            <button class="chip" type="button">üí¨ How are you?</button>
            <button class="chip" type="button">üòÆ‚Äçüí® Shortness of breath</button>
          </div>
        </div>
      `;

      messagesEl.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          inputEl.value = chip.textContent.replace(/^.{2}/, "").trim();
          composerEl.dispatchEvent(new Event("submit", { cancelable: true }));
        });
      });
    }

    function render() {
      messagesEl.innerHTML = "";
      if (chat.length === 0) {
        renderWelcome();
        return;
      }

      chat.forEach((msg, index) => {
        const isUser = msg.role === "user";
        const row = document.createElement("div");
        row.className = `msg ${msg.role}`;
        const renderedText = isUser ? formatText(msg.text) : formatAssistantRichText(msg.text);
        row.innerHTML = `
          <div class="msg_avatar">${isUser ? userInitial : "ü©∫"}</div>
          <div class="bubble ${isUser ? "" : "assistant_bubble"}">
            <div class="text">${renderedText}</div>
            <div class="time">${isUser ? "" : "ü©∫ HealthBud ¬∑ "}${timeStr(msg.ts)}</div>
          </div>
        `;
        messagesEl.appendChild(row);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addMsg(role, text) {
      chat.push({ role, text, ts: Date.now() });
      saveChat();
      render();
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function addAssistantMsgAnimated(text) {
      const fullText = String(text || "");
      const prefersReducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      if (prefersReducedMotion || fullText.length < 20) {
        addMsg("assistant", fullText);
        return;
      }

      const message = { role: "assistant", text: "", ts: Date.now() };
      chat.push(message);
      saveChat();
      render();

      const textNodes = messagesEl.querySelectorAll(".msg.assistant .text");
      const target = textNodes[textNodes.length - 1];
      if (!target) {
        message.text = fullText;
        saveChat();
        render();
        return;
      }

      target.classList.add("revealing");

      const chunkSize = fullText.length > 1500 ? 20 : fullText.length > 800 ? 14 : fullText.length > 350 ? 9 : 6;
      const delay = fullText.length > 900 ? 12 : 18;

      for (let i = chunkSize; i <= fullText.length; i += chunkSize) {
        const partial = fullText.slice(0, i);
        message.text = partial;
        target.innerHTML = formatText(partial);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        await sleep(delay);
      }

      message.text = fullText;
      target.innerHTML = formatAssistantRichText(fullText);
      target.classList.remove("revealing");
      saveChat();
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTyping() {
      const row = document.createElement("div");
      row.className = "msg assistant typing";
      row.id = "typingRow";
      row.innerHTML = `
        <div class="msg_avatar">ü©∫</div>
        <div class="bubble typing_bubble">
          <span class="typing_dot"></span>
          <span class="typing_dot"></span>
          <span class="typing_dot"></span>
        </div>
      `;
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function hideTyping() {
      const el = document.getElementById("typingRow");
      if (el) el.remove();
    }

    function inferSymptomsFromText(text) {
      const cleaned = text.toLowerCase();
      const known = [
        "chest pain", "shortness of breath", "headache", "fever", "nausea",
        "cough", "vomiting", "dizziness", "abdominal pain", "sore throat"
      ];
      const match = known.find(symptom => cleaned.includes(symptom));
      if (!match) return [];

      const levelMatch = text.match(/\b(?:severity|pain\s*level|level)\s*(?:is|=|:)?\s*(10|[0-9])\b/i);
      const severity = levelMatch ? Math.max(0, Math.min(10, Number(levelMatch[1]))) : 5;
      return [{ name: match, severity }];
    }

    function looksLikeFollowUp(text) {
      const t = String(text || "").toLowerCase();
      const followUpTerms = [
        "what should i do",
        "what now",
        "is this serious",
        "is it dangerous",
        "should i be worried",
        "still",
        "again",
        "worse",
        "better",
        "next",
        "now what",
      ];
      return followUpTerms.some(term => t.includes(term));
    }

    function getRecentTimelineSymptoms(limit = 3) {
      let logs = [];
      try { logs = JSON.parse(localStorage.getItem(TIMELINE_KEY) || "[]"); }
      catch { logs = []; }

      return logs
        .slice(0, limit)
        .filter(item => item && item.symptom)
        .map(item => ({
          name: String(item.symptom),
          severity: Number.isFinite(Number(item.severity)) ? Math.max(0, Math.min(10, Number(item.severity))) : 5,
          notes: item.notes ? String(item.notes).slice(0, 180) : undefined,
        }));
    }

    function buildAssistantReply(data) {
      const assessment = data.assessment || {};
      const primary = (assessment.assistant_message || assessment.summary || "I‚Äôm here with you.").trim();
      if (assessment.show_structured_output === false) {
        return primary;
      }

      const conditions = (assessment.possible_conditions || []).join(", ") || "No clear condition listed";
      const remedies = (assessment.possible_remedies || []).map(item => `‚Ä¢ ${item}`).join("\n");
      const followUps = (assessment.follow_up_questions || []).map(item => `‚Ä¢ ${item}`).join("\n");

      return [
        primary,
        "",
        "---",
        "",
        `Urgency: ${assessment.urgency_level || "unknown"}`,
        `When to seek care: ${assessment.seek_care_within || "N/A"}`,
        `Reason: ${assessment.urgency_reason || "N/A"}`,
        "",
        `Summary: ${assessment.summary || "N/A"}`,
        `Possible conditions: ${conditions}`,
        remedies ? `\nPossible remedies:\n${remedies}` : "",
        followUps ? `\nFollow-up questions:\n${followUps}` : "",
      ].filter(Boolean).join("\n");
    }

    function shouldRedirectToUrgentCare(assessment) {
      const urgency = String(assessment?.urgency_level || "").toLowerCase();
      return urgency === "high" || urgency === "emergency";
    }

    function redirectToUrgentCare(assessment) {
      const urgency = String(assessment?.urgency_level || "high").toLowerCase();
      const reason = String(assessment?.urgency_reason || "Higher-risk symptoms detected.");
      const seekWithin = String(assessment?.seek_care_within || "As soon as possible.");

      localStorage.setItem(
        "hb_urgent_handoff",
        JSON.stringify({
          urgency,
          reason,
          seekWithin,
          ts: Date.now(),
        })
      );

      addMsg(
        "assistant",
        "I‚Äôm directing you to urgent care options nearby now so you can get help quickly."
      );

      setTimeout(() => {
        const target = `./findcare.html?mode=urgent&urgency=${encodeURIComponent(urgency)}`;
        window.location.href = target;
      }, 900);
    }

    async function fetchAssistantReply(text) {
      const inferredSymptoms = inferSymptomsFromText(text);
      const timelineSymptoms = inferredSymptoms.length === 0 && looksLikeFollowUp(text)
        ? getRecentTimelineSymptoms(3)
        : [];

      const payload = {
        message: text,
        locale: "en-NG",
        symptoms: [...inferredSymptoms, ...timelineSymptoms],
        session_id: sessionId || undefined,
      };

      const res = await fetch(`${API_BASE}/chat/assess`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const details = await res.text();
        throw new Error(`Backend request failed (${res.status}): ${details}`);
      }

      const data = await res.json();
      if (data && typeof data.session_id === "string" && data.session_id.trim()) {
        saveSessionId(data.session_id.trim());
      }
      return {
        replyText: buildAssistantReply(data),
        assessment: data.assessment || {},
      };
    }

    composerEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;

      addMsg("user", text);
      inputEl.value = "";
      inputEl.focus();
      sendBtn.disabled = true;
      showTyping();

      try {
        if (!backendAvailable) {
          await checkBackend();
        }

        const result = await fetchAssistantReply(text);
        setStatus("online", "AI Connected");
        await addAssistantMsgAnimated(result.replyText);

        if (shouldRedirectToUrgentCare(result.assessment)) {
          redirectToUrgentCare(result.assessment);
        }
      } catch (error) {
        setStatus("offline", "Offline");
        const message = error instanceof Error ? error.message : String(error);
        addMsg("assistant", `I‚Äôm having trouble reaching the AI service right now. ${message}`);
      } finally {
        hideTyping();
        sendBtn.disabled = false;
      }
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      if (chat.length && !confirm("Clear this conversation?")) return;
      chat = [];
      saveChat();
      saveSessionId("");
      render();
    });

    loadChat();
    render();
    checkBackend();
  </script>
</body>
</html>