<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./chat.css" />
  <title>HealthBud â€¢ Chat</title>
</head>
<body>

  <!-- ===== Topbar ===== -->
  <header class="topbar">
    <a class="back" href="./homepage.html">â† Home</a>
    <div class="brand" aria-label="HealthBud">
      <div class="brand_mark" aria-hidden="true"></div>
      <h1 class="brand_name">HealthBud</h1>
    </div>
    <div class="topbar_actions">
      <button class="ghost_btn" id="clearBtn" type="button">Clear Chat</button>
    </div>
  </header>

  <!-- ===== Chat ===== -->
  <main class="chat_shell" aria-label="Chat">
    <section class="chat_card">

      <!-- Header with AI avatar -->
      <div class="chat_header">
        <div class="ai_avatar" aria-hidden="true">ğŸ©º</div>
        <div class="header_text">
          <h2 id="headerTitle">HealthBud Assistant</h2>
          <p class="header_sub" id="headerSub">Your personal health companion</p>
        </div>
        <div class="status_pill offline" id="statusPill">
          <span class="status_dot"></span>
          <span id="statusText">Ready</span>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>

      <!-- Composer -->
      <form class="composer" id="composer" autocomplete="off">
        <div class="composer_input_wrap">
          <input
            id="messageInput"
            type="text"
            placeholder="Describe how you're feelingâ€¦"
            aria-label="Message"
            required
          />
        </div>
        <button class="send_btn" type="submit" id="sendBtn" aria-label="Send message">
          <span class="send_icon">âœ</span>
        </button>
      </form>

      <!-- Disclaimer -->
      <p class="disclaimer">
        HealthBud provides informational guidance only â€” not medical diagnoses. Always consult a healthcare professional.
      </p>

    </section>
  </main>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 0) Auth guard
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const token = localStorage.getItem("hb_token");
    if (!token) window.location.href = "./getstarted.html";

    let userName = "there";
    let userInitial = "U";
    try {
      const u = JSON.parse(localStorage.getItem("hb_user") || "{}");
      if (u.name) {
        userName = u.name.split(" ")[0];
        userInitial = u.name.charAt(0).toUpperCase();
      }
    } catch {}

    document.getElementById("headerSub").textContent =
      `Hi ${userName} â€” tell me what's going on and I'll help you think through it.`;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1) Backend detection
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const API_BASE = "http://127.0.0.1:8000";
    let backendAvailable = false;
    let conversationId = null;

    async function checkBackend() {
      try {
        const res = await fetch(`${API_BASE}/health`, { signal: AbortSignal.timeout(2000) });
        if (res.ok) {
          backendAvailable = true;
          setStatus("online", "AI Connected");
        }
      } catch {
        backendAvailable = false;
        setStatus("offline", "Ready");
      }
    }

    function setStatus(type, text) {
      const pill = document.getElementById("statusPill");
      const label = document.getElementById("statusText");
      pill.className = `status_pill ${type}`;
      label.textContent = text;
    }

    checkBackend();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2) State + persistence
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const STORAGE_KEY = "hb_chat_messages_v1";
    const messagesEl  = document.getElementById("messages");
    const inputEl     = document.getElementById("messageInput");
    const composerEl  = document.getElementById("composer");
    const sendBtn     = document.getElementById("sendBtn");

    let chat = [];

    function loadChat() {
      try { chat = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { chat = []; }
    }

    function saveChat() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chat));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3) Render
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function esc(s) {
      return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
              .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function formatText(text) {
      // Convert **bold** to <strong>
      let html = esc(text);
      html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      return html;
    }

    function timeStr(ts) {
      return new Date(ts).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
    }

    function render() {
      messagesEl.innerHTML = "";

      if (chat.length === 0) {
        renderWelcome();
        return;
      }

      for (const msg of chat) {
        const isUser = msg.role === "user";
        const row = document.createElement("div");
        row.className = `msg ${msg.role}`;

        row.innerHTML = `
          <div class="msg_avatar">${isUser ? userInitial : "ğŸ©º"}</div>
          <div class="bubble">
            <div class="text">${formatText(msg.text)}</div>
            <div class="time">
              ${isUser ? "" : "ğŸ©º HealthBud Â· "}${timeStr(msg.ts)}
            </div>
          </div>
        `;
        messagesEl.appendChild(row);
      }

      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderWelcome() {
      messagesEl.innerHTML = `
        <div class="welcome">
          <div class="welcome_icon">ğŸ©º</div>
          <h3>How can I help you today?</h3>
          <p>
            Describe your symptoms, ask health questions, or pick a topic below.
            I'll help you understand what might be going on and when to seek care.
          </p>
          <div class="quick_chips" id="quickChips">
            <button class="chip" type="button">ğŸ¤’ I have a fever</button>
            <button class="chip" type="button">ğŸ¤• Headache for days</button>
            <button class="chip" type="button">ğŸ¤¢ Feeling nauseous</button>
            <button class="chip" type="button">ğŸ˜®â€ğŸ’¨ Shortness of breath</button>
            <button class="chip" type="button">ğŸ˜´ Always tired</button>
            <button class="chip" type="button">ğŸ©¹ I got injured</button>
            <button class="chip" type="button">ğŸ˜Ÿ Feeling anxious</button>
            <button class="chip" type="button">ğŸ¤§ Cold or flu symptoms</button>
          </div>
        </div>
      `;

      // Chip click handlers
      messagesEl.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          inputEl.value = chip.textContent.replace(/^.{2}/, "").trim();
          composerEl.dispatchEvent(new Event("submit", { cancelable: true }));
        });
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4) Demo assistant
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function demoReply(text) {
      const t = text.toLowerCase();

      const emergency = /chest pain|can't breathe|cannot breathe|severe bleeding|faint|stroke|suicid|overdose|heart attack|seizure/.test(t);
      if (emergency) {
        return "âš ï¸ **This sounds like it could be a medical emergency.**\n\n" +
          "Please take these steps now:\n" +
          "â€¢ **Call emergency services** (911 / 999 / 112)\n" +
          "â€¢ If someone is with you, ask them to help\n" +
          "â€¢ Don't drive yourself â€” wait for emergency services\n\n" +
          "If you're safe and want to describe more, I'm here.\n\n" +
          "âš•ï¸ *This is informational guidance, not a medical diagnosis.*";
      }

      const greeting = /^(hi|hello|hey|good morning|good afternoon|good evening|sup|yo)[\s!.,]*$/i.test(text.trim());
      if (greeting) {
        return `Hey ${userName}! ğŸ‘‹\n\nI'm your HealthBud assistant. Tell me about:\n\n` +
          "â€¢ **Symptoms** you're experiencing\n" +
          "â€¢ **How long** they've been going on\n" +
          "â€¢ **Anything else** on your mind\n\n" +
          "What's going on today?";
      }

      const thanks = /^(thanks|thank you|thx|ty|appreciate)[\s!.,]*$/i.test(text.trim());
      if (thanks) {
        return "You're welcome! ğŸ˜Š Remember to take care of yourself. I'm here if you need anything else.\n\n" +
          "âš•ï¸ *This is informational guidance, not a medical diagnosis.*";
      }

      // Symptom detection
      const fever     = /fever|temperature|chills|sweating/.test(t);
      const headache  = /headache|head hurt|head pain|migraine/.test(t);
      const stomach   = /stomach|nausea|vomit|diarrhea|abdomen|belly|cramp/.test(t);
      const throat    = /sore throat|throat pain|swallow|tonsil/.test(t);
      const cough     = /cough|congestion|runny nose|cold|flu|sneez/.test(t);
      const skin      = /rash|itch|hives|swelling|bump|bruise/.test(t);
      const pain      = /pain|hurt|ache|sore|tender/.test(t);
      const fatigue   = /tired|fatigue|exhausted|weak|drowsy|no energy/.test(t);
      const anxiety   = /anxi|stress|panic|nervous|worried|can't sleep|insomnia/.test(t);
      const injury    = /fall|fell|twist|sprain|broken|fracture|cut|wound|burn/.test(t);
      const breath    = /breath|breathing|shortness|wheez/.test(t);

      let reply = `Thanks for sharing that, ${userName}. Let me help.\n\n`;
      let q = [], tips = [];

      if (fever) {
        q.push("What's the highest temperature you've measured?");
        q.push("When did it start?");
        q.push("Any body aches, chills, or rash?");
        tips.push("Stay hydrated and rest");
        tips.push("Over-the-counter fever reducers may help");
        tips.push("**Seek care** if it's above 103Â°F (39.4Â°C) or lasts 3+ days");
      }
      if (headache) {
        q.push("Where exactly is the pain â€” front, sides, or back?");
        q.push("Severity on a 0â€“10 scale?");
        q.push("Any sensitivity to light, nausea, or vision changes?");
        tips.push("Rest in a dark, quiet room");
        tips.push("Hydrate â€” dehydration is a common trigger");
        tips.push("**Seek care** if sudden and severe, or the worst headache ever");
      }
      if (stomach) {
        q.push("Where is the discomfort â€” upper, lower, left, right?");
        q.push("Any vomiting, diarrhea, or blood?");
        q.push("Eaten anything unusual recently?");
        tips.push("Try bland foods â€” toast, rice, bananas");
        tips.push("Sip clear fluids slowly");
        tips.push("**Seek care** if severe pain, blood, or can't keep fluids down");
      }
      if (throat) {
        q.push("Can you swallow liquids okay?");
        q.push("Any white patches on your tonsils?");
        q.push("Fever or swollen glands?");
        tips.push("Warm salt water gargles help");
        tips.push("Stay hydrated with warm liquids");
        tips.push("**Seek care** if it lasts over a week or breathing is affected");
      }
      if (cough) {
        q.push("Dry cough or producing mucus?");
        q.push("What color is the mucus?");
        q.push("Any wheezing or shortness of breath?");
        tips.push("Honey in warm water soothes a cough");
        tips.push("Use a humidifier");
        tips.push("**Seek care** if coughing blood or difficulty breathing");
      }
      if (breath) {
        q.push("Does it happen at rest or only with activity?");
        q.push("When did this start?");
        q.push("Any chest pain, wheezing, or swelling?");
        tips.push("Sit upright and try slow, deep breaths");
        tips.push("**Seek urgent care** if it's sudden, severe, or with chest pain");
      }
      if (skin) {
        q.push("Where on your body is it?");
        q.push("Is it spreading, itchy, or painful?");
        q.push("Started any new products or medications?");
        tips.push("Avoid scratching");
        tips.push("A cool compress may help");
        tips.push("**Seek care** if spreading rapidly or face/throat swelling");
      }
      if (anxiety) {
        q.push("How long have you been feeling this way?");
        q.push("Specific triggers or random onset?");
        q.push("Affecting sleep, appetite, or daily life?");
        tips.push("Try breathing: in 4 counts, hold 4, out 6");
        tips.push("Physical activity helps reduce anxiety");
        tips.push("Speaking to a professional is a sign of **strength**");
      }
      if (injury) {
        q.push("How did it happen?");
        q.push("Can you move the affected area?");
        q.push("Swelling, bruising, or deformity?");
        tips.push("**RICE**: Rest, Ice (20 min on/off), Compression, Elevation");
        tips.push("**Seek care** if you can't bear weight or there's visible deformity");
      }
      if (fatigue) {
        q.push("How long has this been going on?");
        q.push("Getting 7â€“9 hours of sleep?");
        q.push("Changes in appetite, weight, or mood?");
        tips.push("Prioritize consistent sleep times");
        tips.push("Stay hydrated and eat balanced meals");
        tips.push("**Seek care** if persistent (2+ weeks) or worsening");
      }

      // Fallback
      if (!q.length) {
        q.push("When did this start?");
        q.push("Is it getting better, worse, or staying the same?");
        q.push("Any other symptoms alongside this?");
        q.push("Severity on a 0â€“10 scale?");
        tips.push("Track your symptoms â€” timing and triggers help");
        tips.push("Stay hydrated and rest");
        tips.push("**Seek care** if symptoms are severe or worsening");
      }

      reply += "ğŸ“‹ **Let me ask a few things:**\n";
      q.forEach(x => reply += `â€¢ ${x}\n`);
      reply += "\nğŸ’¡ **In the meantime:**\n";
      tips.forEach(x => reply += `â€¢ ${x}\n`);
      reply += "\nShare more details and I'll refine my suggestions.\n\n";
      reply += "âš•ï¸ *This is informational guidance, not a medical diagnosis. Please consult a healthcare professional.*";

      return reply;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5) Backend call
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function getBackendReply(text) {
      try {
        const body = { message: text };
        if (conversationId) body.conversation_id = conversationId;

        const res = await fetch(`${API_BASE}/chat/send`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) throw new Error();
        const data = await res.json();
        conversationId = data.conversation_id;
        return data.assistant_message.content;
      } catch {
        backendAvailable = false;
        setStatus("offline", "Offline");
        return demoReply(text);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 6) Send message
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function addMsg(role, text) {
      chat.push({ role, text, ts: Date.now() });
      saveChat();
      render();
    }

    function showTyping() {
      const row = document.createElement("div");
      row.className = "msg assistant typing";
      row.id = "typingRow";
      row.innerHTML = `
        <div class="msg_avatar">ğŸ©º</div>
        <div class="bubble typing_bubble">
          <span class="typing_dot"></span>
          <span class="typing_dot"></span>
          <span class="typing_dot"></span>
        </div>
      `;
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function hideTyping() {
      const el = document.getElementById("typingRow");
      if (el) el.remove();
    }

    composerEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;

      addMsg("user", text);
      inputEl.value = "";
      inputEl.focus();
      sendBtn.disabled = true;

      showTyping();

      let reply;
      if (backendAvailable) {
        reply = await getBackendReply(text);
      } else {
        await new Promise(r => setTimeout(r, 350 + Math.random() * 500));
        reply = demoReply(text);
      }

      hideTyping();
      sendBtn.disabled = false;
      addMsg("assistant", reply);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 7) Clear
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById("clearBtn").addEventListener("click", () => {
      if (chat.length && !confirm("Clear this conversation?")) return;
      chat = [];
      conversationId = null;
      saveChat();
      render();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Init
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    loadChat();
    render();
  </script>
</body>
</html>