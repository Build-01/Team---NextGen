<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./chat.css" />
  <title>HealthBud • Chat</title>
</head>
<body>
  <header class="topbar">
    <a class="back" href="./homepage.html">← Home</a>

    <div class="brand" aria-label="HealthBud">
      <div class="brand_mark" aria-hidden="true"></div>
      <h1 class="brand_name">HealthBud</h1>
    </div>

    <button class="ghost_btn" id="clearBtn" type="button">Clear</button>
  </header>

  <main class="chat_shell" aria-label="Chat">
    <section class="chat_card" aria-label="Conversation">
      <div class="chat_header">
        <div>
          <h2>Chat</h2>
          <p class="muted" id="welcomeLine">Talk about symptoms. I’ll help you think through next steps.</p>
        </div>
        <span class="pill" id="statusPill">Demo mode</span>
      </div>

      <div class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions"></div>

      <div class="composer" id="composer" aria-label="Message composer">
        <textarea
          id="messageInput"
          placeholder="Type a message…"
          aria-label="Message"
        ></textarea>
        <button class="send_btn" id="sendBtn" type="button">Send</button>
      </div>
    </section>
  </main>

  <script>
    // ----------------------------
    // 0) Auth guard (demo session)
    // ----------------------------
    const token = localStorage.getItem("hb_token");
    if (!token) window.location.href = "./getstarted.html";

    const userRaw = localStorage.getItem("hb_user");
    let userName = "there";
    try {
      const user = userRaw ? JSON.parse(userRaw) : null;
      if (user?.name) userName = user.name;
    } catch {}
    document.getElementById("welcomeLine").textContent =
      `Hi ${userName} — describe your symptoms and I’ll fetch a backend triage assessment.`;

    // ----------------------------
    // 1) State + persistence
    // ----------------------------
    const STORAGE_KEY = "hb_chat_messages_v1";
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const statusPill = document.getElementById("statusPill");

    const API_BASE = "http://127.0.0.1:8000/api/v1";

    /** @type {{role:'user'|'assistant', text:string, ts:number}[]} */
    let chat = [];

    function loadChat() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        chat = raw ? JSON.parse(raw) : [];
      } catch {
        chat = [];
      }
    }

    function saveChat() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chat));
    }

    // ----------------------------
    // 2) Rendering
    // ----------------------------
    function escapeHtml(str) {
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function render() {
      messagesEl.innerHTML = "";

      if (chat.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.innerHTML = `
          <h3>Start a conversation</h3>
          <p>Example: “I have a headache and sore throat for 2 days.”</p>
        `;
        messagesEl.appendChild(empty);
        return;
      }

      for (const msg of chat) {
        const row = document.createElement("div");
        row.className = `msg ${msg.role}`;

        row.innerHTML = `
          <div class="bubble">
            <div class="text">${escapeHtml(msg.text)}</div>
            <div class="time">${new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          </div>
        `;
        messagesEl.appendChild(row);
      }

      // scroll to newest
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function extractSeverity(text) {
      const match = text.match(/\b(?:severity|pain\s*level|level)\s*(?:is|=|:)?\s*(10|[0-9])\b/i);
      if (!match) return 5;
      return Math.max(0, Math.min(10, Number(match[1])));
    }

    function extractPrimarySymptom(text) {
      const cleaned = text
        .replace(/[.,!?]/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .toLowerCase();

      const known = [
        "chest pain",
        "shortness of breath",
        "headache",
        "fever",
        "nausea",
        "cough",
        "vomiting",
        "dizziness",
        "abdominal pain",
        "sore throat",
      ];

      for (const symptom of known) {
        if (cleaned.includes(symptom)) return symptom;
      }
      return null;
    }

    function formatAssessmentDetails(data) {
      const assessment = data.assessment || {};
      const conditions = (assessment.possible_conditions || []).join(", ") || "No clear condition listed";
      const remedies = (assessment.possible_remedies || []).map(item => `• ${item}`).join("\n") || "• No remedy listed";
      const followUps = (assessment.follow_up_questions || []).map(item => `• ${item}`).join("\n");

      return [
        `Urgency: ${assessment.urgency_level || "unknown"}`,
        `When to seek care: ${assessment.seek_care_within || "N/A"}`,
        `Reason: ${assessment.urgency_reason || "N/A"}`,
        "",
        `Summary: ${assessment.summary || "N/A"}`,
        `Possible conditions: ${conditions}`,
        "",
        "Possible remedies:",
        remedies,
        "",
        "Follow-up questions:",
        followUps || "• None",
      ].join("\n");
    }

    function formatAssistantReply(data) {
      const assessment = data.assessment || {};
      const conversational = (assessment.assistant_message || "").trim();
      if (!conversational) return formatAssessmentDetails(data);

      if (assessment.show_structured_output === false) {
        return conversational;
      }

      const hasHealthDetails =
        (assessment.possible_conditions || []).length > 0 ||
        (assessment.follow_up_questions || []).length > 0 ||
        (assessment.possible_remedies || []).length > 0;

      if (!hasHealthDetails) {
        return conversational;
      }

      return `${conversational}\n\n---\n\n${formatAssessmentDetails(data)}`;
    }

    async function requestBackendAssessment(messageText) {
      const inferredSymptom = extractPrimarySymptom(messageText);
      const symptoms = inferredSymptom
        ? [{ name: inferredSymptom, severity: extractSeverity(messageText) }]
        : [];

      const payload = {
        message: messageText,
        locale: "en-NG",
        symptoms,
      };

      const response = await fetch(`${API_BASE}/chat/assess`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const details = await response.text();
        throw new Error(`Backend request failed (${response.status}): ${details}`);
      }

      return response.json();
    }

    // ----------------------------
    // 4) Sending messages
    // ----------------------------
    function addMessage(role, text) {
      chat.push({ role, text, ts: Date.now() });
      saveChat();
      render();
    }

    function addTypingBubble() {
      const row = document.createElement("div");
      row.className = "msg assistant";
      row.id = "typingRow";
      row.innerHTML = `
        <div class="bubble typing">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      `;
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function removeTypingBubble() {
      const el = document.getElementById("typingRow");
      if (el) el.remove();
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;

      addMessage("user", text);
      inputEl.value = "";
      inputEl.focus();

      sendBtn.disabled = true;
      statusPill.textContent = "Contacting backend...";
      addTypingBubble();

      try {
        const result = await requestBackendAssessment(text);
        removeTypingBubble();
        addMessage("assistant", formatAssistantReply(result));
        statusPill.textContent = "Backend connected";
      } catch (error) {
        removeTypingBubble();
        const message = error instanceof Error ? error.message : String(error);
        addMessage("assistant", `Integration error: ${message}`);
        statusPill.textContent = "Backend error";
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    inputEl.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    // Clear conversation
    document.getElementById("clearBtn").addEventListener("click", () => {
      chat = [];
      saveChat();
      render();
    });

    // initial
    loadChat();
    statusPill.textContent = "Backend ready";
    render();
  </script>
</body>
</html>